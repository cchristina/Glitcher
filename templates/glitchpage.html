{% extends 'base.html' %}




{% block content %}



<h1> Eventually you will glitch pix here! </h1>

<a href = "/"> go back home </a>

<br>
<!-- <div id="thumbnails">
{% for image in images %}

<img src ="{{image.url}}" style="max-height: 100px;" onclick="$('img#largeImage').attr('src', '{{image.url}}' );">

{% endfor %}
</div>

<div id="fullsize">

<img id="largeImage" src="" style="max-width: 800px; max-height: 600px;">

</div> -->


<!-- <img id="newImage" src={{newImage}} style="max-width: 800px; display: none;"> -->


<br><br>
<button onclick="switchRun()">start/stop</button> 
<button id="stepButton" onclick="stepGOL()">step</button>
<input type="range" min="1" max="1000" value="500" class="slider" id="speedControl" label="speed" style="display:none"><br>

<button id="save" onclick="getURL()">save</button>


<br><br>
    
<canvas  id="myCanvas" width="{{canvas_width}}" height="{{canvas_height}}" style="border:1px solid #d3d3d3;"> <!-- draggable="true" onclick= "changeCellsWithCursor"(document.getElementById('myCanvas'), (evt))"> -->
    Your browser does not support the HTML5 canvas tag.</canvas>



<!-- <script type="text/javascript" src="../static/scripts/CA.js"> -->
    <script>

// import saveAs from 'FileSaver';


cellMatrix = populateBoard();
// cellMatrix = oneDBoard(populateOneD(), 110);


//     window.onload = function() {
//     var canvas = document.getElementById("myCanvas");
//     var ctx = canvas.getContext("2d");

                
// };
    var c = document.getElementById("myCanvas");
    var ctx = c.getContext("2d");

    


    var img = new Image();
    img.src = "{{oldImage}}";


    var overlayImg = new Image();
    overlayImg.src = "{{newImage}}";


    let mouseDown = false;

    let justChanged = []


    var slider = document.getElementById("speedControl");

    let speed = 1000 - slider.value;

    // output.innerHTML = slider.value; // Display the default slider value

// Update the current slider value (each time you drag the slider handle)
slider.oninput = function() {
    // output.innerHTML = this.value;
    console.log(this.value);
    speed = 1000 - this.value;
}




    // function changeCellsWithCursor(canvas, event) {

    //     var boundingRect = canvas.getBoundingClientRect();
    //     var x = Math.floor((event.clientX - boundingRect.left)/cellSize) +2; //+1;
    //     var y = Math.floor((event.clientY - boundingRect.top)/cellSize)+1;
    //     // var x = Math.floor((event.offsetX)/cellSize)+1;
    //     // var y = Math.floor((event.offsetY)/cellSize);

    //     let slot = y*matrixSize+x

    //     var eType = event.type

    //     if (eType == "click"){
                
    //             flipCell(x,y);
    //             displayRects(overlayImg)
    //          }


    //     if (mouseDown  && !justChanged.includes(slot)) {
                

    //                 // flipCell(x,y);

    //                 if (!event.shiftKey){
    //                   cellMatrix[x][y] = 1;  
    //                 }else{

    //                     cellMatrix[x][y] = 0; 
    //                 }
                    
    //                 justChanged.push(slot);
    //                 displayRects(overlayImg)




    //     }

    // }


    function changeCellWithClick(canvas, event){

        var boundingRect = canvas.getBoundingClientRect();
        var x = Math.floor((event.clientX - boundingRect.left)/cellSize)+1;
        var y = Math.floor((event.clientY - boundingRect.top)/cellSize);


     
        flipCell(x,y);
        displayRects(overlayImg)
    }
 

myCanvas.addEventListener("mousemove", function (e) { changeCellsWithCursor(myCanvas, e);});
myCanvas.addEventListener("click", function (e) { changeCellsWithCursor(myCanvas, e);});

myCanvas.addEventListener("mousedown", function(e) {isMouseDown(e)});
myCanvas.addEventListener("mouseup", function(e) {isMouseUp(e)});

function isMouseDown(event){


    mouseDown = true;
    return true;
}

function isMouseUp(event){

    mouseDown = false;
    justChanged = []
    return true;
}




    (function caLoop (i) {          
        setTimeout(function () {   

            if (willRun)
            {
                cellMatrix = gameOfLifeRound(cellMatrix);
            }

            ctx.drawImage(img, 0, 0, 800, 800);
            displayRects(overlayImg);

            ;

        if (--i) caLoop(i);      
        }, speed) //100)
    })(5000);  


    function stepGOL(){

        cellMatrix = gameOfLifeRound(cellMatrix);
    }


    let willRun = false;

    function switchRun(){

        willRun = !willRun;

        var x = document.getElementById("stepButton");
        if (x.style.display === "none") {
             x.style.display = "block";
        } else {
          x.style.display = "none";
        }
        x = document.getElementById("speedControl");
        if (x.style.display === "none") {
             x.style.display = "block";
        } else {
          x.style.display = "none";
        }


    }


function getURL(){
    let canvas = document.getElementById('myCanvas');
    let url = canvas.toDataURL();

    // return url;

    // console.log(dataURL);
    // window.open(canvas.toDataURL());

    var savefile = prompt("What would you like to save as? Be careful not to overwrite anything!", "myglitch");
    // saveAs(url, savefile + ".png");
    var a = document.createElement("a");
    a.href = url;
    fileName = url.split("/").pop();
    a.download = savefile;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    a.remove();
}

// function saveImage(){

//     let canvas = document.getElementById('myCanvas');

//     var link = document.createElement("a");

//     link.download = "image.png";

//     canvas.toBlob(function(blob){
//     link.href = URL.createObjectURL(blob);
//     console.log(blob);
//     console.log(link.href); // this line should be here
//   },'image/png');


//   link.click();

// }



</script>


{% endblock %}